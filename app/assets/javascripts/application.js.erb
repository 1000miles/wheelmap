/*global  window, jQuery, $, language, _gaq*/
/*jslint devel: true, browser: true, maxerr: 200, indent: 2, sloppy: true, nomen: true */

jQuery.migrateMute = true;

jQuery.parseQuery = function(qs,options) {
  var q = (typeof qs === 'string'?qs:window.location.search), o = {'f':function(v){return unescape(v).replace(/\+/g,' ');}}, options = (typeof qs === 'object' && typeof options === 'undefined')?qs:options, o = jQuery.extend({}, o, options), params = {};
  jQuery.each(q.match(/^\??(.*)$/)[1].split('&'),function(i,p){
    p = p.split('=');
    p[1] = o.f(p[1]);
    params[p[0]] = params[p[0]]?((params[p[0]] instanceof Array)?(params[p[0]].push(p[1]),params[p[0]]):[params[p[0]],p[1]]):p[1];
  });
  return params;
}

var map;
var epsg4326, epsg900913;
if (!window.zoom) {
  var zoom = 14;
}

function runEffect() {
  setTimeout(function () {
    var selectedEffect = 'blind';
    var options = {};
    $(".flash").fadeOut();
  }, 5000);
}

function add_socia_script (d, t, src) {
  var g = d.createElement(t),
  s = d.getElementsByTagName(t)[0];
  g.async = true;
  g.src = src;
  s.parentNode.insertBefore(g, s);
};

function getURLParameter(name) {
  return decodeURI(
    (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search) || [,null])[1]
  ).replace(/\+/g, " ");
}

$(function () {
  $('a[data=show]').live('click', function () {
    $(this).parent().fadeIn();
    return false;
  });
  $('a[data=hide]').live('click', function () {
    $(this).parent().fadeOut();
    return false;
  });
  $('.minimize').live('click', function () {
    $(this).parent('div').animate({ left: '-360px'}, 'fast', 'swing', function () {
      $(this).children('.minimize').addClass('maximize').removeClass('minimize');
      $.cookie('minimized_filter', true);
      if (window._gaq) {
        _gaq.push(['_trackEvent', 'Filter', 'collapse']);
      }
    });
    return false;
  });

  $('.maximize').live('click', function () {
    $(this).parent('div').animate({ left: '0px'}, 'fast', 'swing', function () {
      $(this).children('.maximize').addClass('minimize').removeClass('maximize');
      $.cookie('minimized_filter', false);
      if (window._gaq) {
        _gaq.push(['_trackEvent', 'Filter', 'expand']);
      }
    });
    return false;
  });

  if ($.cookie('minimized_filter') === 'true') {
    $('#sidebar').addClass('minimized')
    $('#sidebar').children('.minimize').addClass('maximize').removeClass('minimize');
  }

  $('input.filter').change(function () {
    if ($(this).is(':checked')) {
      removeFilter($(this).attr('rel'), $(this).attr('value'));
    } else {
      addFilter($(this).attr('rel'), $(this).attr('value'));
    }
  });

  $('input.filter').each(function() {
    if (FilterSettings.get($(this).attr('rel'), $(this).attr('value')) === true) {
      $(this).attr('checked', false).trigger('change');
      $(this)
    }
  });
  //Simon UI fixes
  $('#amenities li label').click(function() {
    $(this).toggleClass('deactivated');
  });
  $(".select-all").click(function() {
    $('#amenities label').removeClass('deactivated');
    $('#amenities input:not(:checked)').trigger('click');
    $(this).addClass('sel-active');
  });
  $(".deselect-all").click(function() {
    $('#amenities label').addClass('deactivated');
    $('#amenities input:checked').trigger('click');
    $(this).addClass('sel-active');
  });
  //end

  if (getURLParameter('q') != 'null' && $('#search').val() == '') {
      $('#search').val(getURLParameter('q'));
  }
  $(window).resize(function () {
    var width = $(window).width() - 750;
    if (width > 100) {
      $('#search').css('width', width + 'px');
    }
  }).resize();
});

function initGeoData() {
  // set global variables
  q = $.parseQuery()
  lat  = q.lat  || $.cookie('last_lat') || $.cookie('geoip_lat') || 52.5167;
  lon  = q.lon  || $.cookie('last_lon') || $.cookie('geoip_lon') || 13.4000;
  zoom = q.zoom || $.cookie('last_zoom') || 14;
  window.node_id = q.node_id
}

function $w(string) {
  return string.split(' ');
}

Flash.transferFromCookies();
Flash.writeDataTo('error', $('#error'));
Flash.writeDataTo('alert', $('#alert'));
Flash.writeDataTo('notice', $('#notice'));

